{% extends "base.html" %}

{% block title %}Productos | {{ pharmacy.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2">
            <i class="fas fa-pills me-2"></i>Gestión de Productos - {{ pharmacy.name }}
        </h1>
        <p class="text-muted">Administra el catálogo de productos de tu farmacia</p>
    </div>
</div>

<!-- Add Product Button -->
<div class="row mb-4">
    <div class="col-12">
        <a href="{{ url_for('pharmacy_admin_add_product', slug=pharmacy.slug) }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Agregar Producto
        </a>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Lista de Productos
        </h5>
    </div>
    <div class="card-body">
        {% if products %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.id }}</td>
                        <td>
                            {% if product.image_url %}
                                <img src="{{ product.image_url }}" alt="{{ product.name }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-pills text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ product.name }}</strong>
                            <br>
                            <small class="text-muted">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</small>
                        </td>
                        <td>
                            {% if product.category %}
                                <span class="badge bg-secondary">{{ product.category.name }}</span>
                            {% else %}
                                <span class="text-muted">Sin categoría</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(product.price) }}</strong>
                        </td>
                        <td>
                            {% if product.stock_quantity > 10 %}
                                <span class="badge bg-success">{{ product.stock_quantity }}</span>
                            {% elif product.stock_quantity > 0 %}
                                <span class="badge bg-warning">{{ product.stock_quantity }}</span>
                            {% else %}
                                <span class="badge bg-danger">Sin stock</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if product.is_active %}
                                <span class="badge bg-success">Activo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" title="Ver detalles" onclick="viewProduct({{ product.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{{ url_for('pharmacy_admin_edit_product', slug=pharmacy.slug, product_id=product.id) }}" class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-warning" title="Gestionar stock" onclick="manageStock({{ product.id }})">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <form method="POST" action="{{ url_for('pharmacy_admin_delete_product', slug=pharmacy.slug, product_id=product.id) }}" style="display: inline;" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-pills fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No hay productos registrados</h5>
            <p class="text-muted">Comienza agregando tu primer producto para tu catálogo.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i>Agregar Primer Producto
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mt-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ products|length }}</h3>
                <p class="mb-0">Total Productos</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ products|selectattr('is_active', 'equalto', true)|list|length }}</h3>
                <p class="mb-0">Productos Activos</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ products|selectattr('stock_quantity', 'lt', 10)|list|length }}</h3>
                <p class="mb-0">Stock Bajo</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ products|selectattr('stock_quantity', 'equalto', 0)|list|length }}</h3>
                <p class="mb-0">Sin Stock</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Agregar Nuevo Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productName" class="form-label">Nombre del Producto *</label>
                            <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productCategory" class="form-label">Categoría</label>
                            <select class="form-select" id="productCategory" name="category_id">
                                <option value="">Seleccionar categoría</option>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productPrice" class="form-label">Precio *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productStock" class="form-label">Stock Inicial *</label>
                            <input type="number" class="form-control" id="productStock" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productSKU" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="productSKU" name="sku">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productImage" class="form-label">Imagen del Producto</label>
                            <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="productActive" name="is_active" checked>
                            <label class="form-check-label" for="productActive">
                                Producto activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="editProductId" name="product_id">
                <div class="modal-body">
                    <!-- Same form fields as add product, but with edit IDs -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProductName" class="form-label">Nombre del Producto *</label>
                            <input type="text" class="form-control" id="editProductName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProductCategory" class="form-label">Categoría</label>
                            <select class="form-select" id="editProductCategory" name="category_id">
                                <option value="">Seleccionar categoría</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductDescription" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editProductDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProductPrice" class="form-label">Precio *</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editProductPrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProductStock" class="form-label">Stock Actual *</label>
                            <input type="number" class="form-control" id="editProductStock" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProductSKU" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="editProductSKU" name="sku">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProductImage" class="form-label">Nueva Imagen</label>
                            <input type="file" class="form-control" id="editProductImage" name="image" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editProductActive" name="is_active">
                            <label class="form-check-label" for="editProductActive">
                                Producto activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Actualizar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Stock Modal -->
<div class="modal fade" id="manageStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-boxes me-2"></i>Gestionar Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="manageStockForm" method="POST">
                <input type="hidden" id="stockProductId" name="product_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="stockAction" class="form-label">Tipo de Movimiento</label>
                        <select class="form-select" id="stockAction" name="action" required>
                            <option value="add">Agregar Stock</option>
                            <option value="remove">Remover Stock</option>
                            <option value="set">Establecer Stock</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stockQuantity" class="form-label">Cantidad</label>
                        <input type="number" class="form-control" id="stockQuantity" name="quantity" min="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stockReason" class="form-label">Motivo</label>
                        <textarea class="form-control" id="stockReason" name="reason" rows="2" placeholder="Ej: Compra de proveedor, Ajuste de inventario, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Actualizar Stock
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Product management functions
function viewProduct(productId) {
    // Implement view product details
    console.log('View product:', productId);
}

function editProduct(productId) {
    // Load product data and show edit modal
    console.log('Edit product:', productId);
    // You would typically make an AJAX call to get product data
    $('#editProductModal').modal('show');
}

function manageStock(productId) {
    $('#stockProductId').val(productId);
    $('#manageStockModal').modal('show');
}

function deleteProduct(productId) {
    if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
        // Implement delete functionality
        console.log('Delete product:', productId);
    }
}

// Form submissions
$(document).ready(function() {
    $('#addProductForm').on('submit', function(e) {
        e.preventDefault();
        // Implement form submission
        console.log('Add product form submitted');
    });
    
    $('#editProductForm').on('submit', function(e) {
        e.preventDefault();
        // Implement form submission
        console.log('Edit product form submitted');
    });
    
    $('#manageStockForm').on('submit', function(e) {
        e.preventDefault();
        // Implement form submission
        console.log('Manage stock form submitted');
    });
});
</script>
{% endblock %}
